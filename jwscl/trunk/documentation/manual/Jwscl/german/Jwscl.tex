%% Buchvorlage unter Verwendung der Book-Klasse des KOMA-Script      %%
%% Basierend auf einer TeXNicCenter-Vorlage von Mark Müller          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Wählen Sie die Optionen aus, indem Sie % vor der Option entfernen  
% Dokumentation des KOMA-Script-Packets: scrguide

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Optionen zum Layout des Buchs                                     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[
%a5paper,							% alle weiteren Papierformat einstellbar
%landscape,						% Querformat
%10pt,								% Schriftgröße (12pt, 11pt (Standard))
%BCOR1cm,							% Bindekorrektur, bspw. 1 cm
%DIVcalc,							% führt die Satzspiegelberechnung neu aus
%											  s. scrguide 2.4
%oneside,							% einseitiges Layout
%twocolumn,						% zweispaltiger Satz
%openany,							% Kapitel können auch auf linken Seiten beginnen
%halfparskip*,				% Absatzformatierung s. scrguide 3.1
%headsepline,					% Trennline zum Seitenkopf	
%footsepline,					% Trennline zum Seitenfuß
%notitlepage,					% in-page-Titel, keine eigene Titelseite
%chapterprefix,				% vor Kapitelüberschrift wird "Kapitel Nummer" gesetzt
%appendixprefix,				% Anhang wird "Anhang" vor die Überschrift gesetzt 
%normalheadings,			% Überschriften etwas kleiner (smallheadings)
%idxtotoc,						% Index im Inhaltsverzeichnis
%liststotoc,					% Abb.- und Tab.verzeichnis im Inhalt
%bibtotoc,						% Literaturverzeichnis im Inhalt
%leqno,								% Nummerierung von Gleichungen links
%fleqn,								% Ausgabe von Gleichungen linksbündig
%draft								% überlangen Zeilen in Ausgabe gekennzeichnet
]
{scrbook}

%\pagestyle{empty}		% keine Kopf und Fußzeile (k. Seitenzahl)
%\pagestyle{headings}	% lebender Kolumnentitel  

%% Normales LaTeX oder pdfLaTeX? %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ==> Das neue if-Kommando "\ifpdf" wird an einigen wenigen
%% ==> Stellen benötigt, um die Kompatibilität zwischen
%% ==> LaTeX und pdfLaTeX herzustellen.
\newif\ifpdf
\ifx\pdfoutput\undefined
	\pdffalse              	%normales LaTeX wird ausgeführt
\else
	\pdfoutput=1           
	\pdftrue               	%pdfLaTeX wird ausgeführt
\fi

%% Fonts für pdfLaTeX, falls keine cm-super-Fonts installiert%%%%%%%%%
\ifpdf
	%\usepackage{ae}        % Benutzen Sie nur
	%\usepackage{zefonts}  	% eines dieser Pakete
\else
	%%Normales LaTeX - keine speziellen Fontpackages notwendig
\fi

%% Packages für Grafiken & Abbildungen %%%%%%%%%%%%%%%%%%%%%%
\ifpdf %%Einbindung von Grafiken mittels \includegraphics{datei}
	\usepackage[pdftex]{graphicx} %%Grafiken in pdfLaTeX
\else
	\usepackage[dvips]{graphicx} %%Grafiken und normales LaTeX
\fi
%\usepackage[hang]{subfigure} %%Mehrere Teilabbildungen in einer Abbildung
%\usepackage{pst-all} %%PSTricks - nicht verwendbar mit pdfLaTeX


%% optischer Randausgleich, falls pdflatex verwandt %%%%%%%%%%%%%%%%%%%
\ifpdf
\usepackage[activate]{pdfcprot}				
\else											% pdfcprot funktioniert nur mit pdflatex
\fi

%% deutsche Anpassung %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[ngerman]{babel}		
\usepackage[T1]{fontenc}							
\usepackage[latin1]{inputenc}		
\usepackage{ae}	
\usepackage{listings} 
% Grafiken 
\usepackage{graphicx} 
% Kopf- und FuÃŸzeilen 
\usepackage{scrpage2} 
% Links 
\usepackage{color} 
\usepackage{hyperref} 
% Listen, aufzÃ¤hlungen  (compactenum, compactitem) 
\usepackage{paralist} 
% Tabellen 
\usepackage{tabularx} 	
\usepackage{multirow} 	

%% Bibliographiestil %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\usepackage{natbib}

\begin{document}
%% Dateiendungen für Grafiken %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ==> Sie können hiermit die Dateiendung einer Grafik weglassen.
%% ==> Aus "\includegraphics{titel.eps}" wird "\includegraphics{titel}".
%% ==> Wenn Sie nunmehr 2 inhaltsgleiche Grafiken "titel.eps" und
%% ==> "titel.pdf" erstellen, wird jeweils nur die Grafik eingebunden,
%% ==> die von ihrem Compiler verarbeitet werden kann.
%% ==> pdfLaTeX benutzt "titel.pdf". LaTeX benutzt "titel.eps".
\ifpdf
	\DeclareGraphicsExtensions{.pdf,.jpg,.png}
\else
	\DeclareGraphicsExtensions{.eps}
\fi

% Link Formatierung 
\definecolor{darkblue}{rgb}{0,0,.5} 
\hypersetup{linktocpage=true, colorlinks=true, breaklinks=true, linkcolor=black, menucolor=black, urlcolor=black} 
% Listings formatieren 
\definecolor{codegray}{gray}{.95} 
\definecolor{darkblue}{rgb}{0,0,.6} 
\definecolor{darkred}{rgb}{.6,0,0} 
\definecolor{darkgreen}{rgb}{0,.6,0} 
\definecolor{red}{rgb}{.98,0,0} 
%\lstset{numbers=left, numberstyle=\tiny, numbersep=3pt, tabsize=3} 
\lstset{basicstyle=\small\ttfamily, frame=single, backgroundcolor=\color{codegray}, breaklines, commentstyle=\itshape\color{darkgreen}, keywordstyle=\bfseries\color{darkblue}, stringstyle=\color{darkred}, xleftmargin=0.5cm}  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
% 
% Code-Beispiele fÃ¼r AufzÃ¤hlungen, Grafiken, Tabellen usw. 
% 
% AufzÃ¤hlungen 
% \begin{compactenum} 
%  \item ... 
% \end{compactenum} 
% 
% \begin{compactitem} 
%  \item ... 
% \end{compactitem} 
% 
% Grafiken 
% \begin{figure}[htb] 
%   \centering 
%   \includegraphics[width=10cm]{Pfad/Dateiname} 
%   \caption{Beschriftung} 
%   \label{fig:Verweis} 
% \end{figure} 
% 
% Tabellen 
% \begin{table} 
%   \centering 
%   \begin{tabularx}{0.90\linewidth}{lX} 
%     \textbf{Ãœberschrift Spalte 1} & \textbf{Ãœberschrift Spalte 2}\\ 
%     \hline 
% 	  Inhalt Spalte 1 Zeile 1	& Inhalt Spalte 2 Zeile 1\\ 
%     \hline 
%   \end{tabularx} 
%   \caption{Beschriftung}   
%   \label{tab:Verweis} 
% \end{table} 
% 
% Verweise 
% \ref{Label} 
% \pageref{Label} 
 
% Quellcode 
% \lstset{language=...} 
% \begin{lstlisting} 
% ... 
% \end{lstlisting} 
% 
% Dateien einbinden 
% \input{Pfad/Dateiname} 
% 
% Literaturverzeichnis 
% \begin{thebibliography}{------} 
%  \bibitem[Verweistext]{label} 
% 	 Autor: \emph{Titel}. Verlag, Auflage, Datum, ISBN 
% \end{thebibliography} 
% 
% \cite{label} 
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Ihr Buch                                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Schmutztitel-Seite %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\extratitle{Schmutztitel}

%% eigene Titelseitengestaltung %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
%\begin{titlepage}
%Einsetzen der TXC Vorlage "Deckblatt" möglich
%\end{titlepage}

%% Angaben zur Standardformatierung des Titels %%%%%%%%%%%%%%%%%%%%%%%%
%\titlehead{Titelkopf}
%\subject{Typisierung}
\title{Programmierung in Windows Sicherheit mit \newline \underline{J}EDI \underline{W}indows \underline{S}ecurity \underline{C}ode \underline{L}ibrary\newline{}JWSCL\newline\textbf{Erster Entwurf}}
\author{Christian Wimmer}
%\and{Der Name des Co-Autoren}
%\thanks{Fußnote}			% entspr. \footnote im Fließtext
%\date{}							% falls anderes, als das aktuelle gewünscht
%\publishers{Herausgeber}

%% Rückseite der Titelseite %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\uppertitleback{Titelrückseitenkopf}
%\lowertitleback{Titelrückseitenfuß}

%% Widmungsseite %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\dedication{Widmung}

\maketitle 						% Titelei wird erzeugt

%% Erzeugung von Verzeichnissen %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tableofcontents			% Inhaltsverzeichnis
%\listoftables				% Tabellenverzeichnis
%\listoffigures				% Abbildungsverzeichnis


%% Der Text %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\frontmatter					% Vorspann (z.B. römische Seitenzahlen)
\chapter{Einleitung}

Während der Programmierung von Windows Anwendungen gab es immer wieder Fälle, in denen ich mich über bestimmte Windows Sicherheitsaspekte sorgen musste. Wollte ich den Computer herunterfahren, so musste zuerst ein bestimmtes Privileg aktiviert werden.
Sollte der Zugriff auf eine Datei für andere Benutzer gestattet sein, so musste dies durch Programmtext erfolgen. Diese und andere
Sicherheitsaspekte sind unter Win32 jedoch nur allein mit der Windows API zu bewerkstelligen, die in C implementiert ist und daher für Delphiprogrammierer etwas schwer zu verwenden ist. Anstatt sich mit dem eigentlichen Problem zu befassen musste ich mir Sorgen
über Zeiger und Strukturen machen, die an bestimmte Funktionen übergeben werden mussten. Besonders dynamische Strukturen, die in ihrer Größe geändert werden können, jedoch in einem Stück im Speicher liegen sind weit entfernt davon "`dynamisch"' zu sein. Änderungen, und wenn sie auch noch so klein sind, bedeuten eine Kopie des Speicherblocks mit der Änderung herzustellen und dann zu verwenden. Das war und ist alles andere als intuitiv und trivial.
Der Beschluss die Win32 Sicherheits API oder zumindest ein Teil davon, als Klassensystem zu implementieren war daher der nächste Schritt. Im Nachhinein gesehen war der Aufwand jedoch alles andere als gering. Er war monumental! Ich fing im Januar 2007 and und noch immer sind nicht alle Implementationen abgeschlossen und zudem fehlen einige Sicherheitsaspekte der Win32 API gänzlich. Der Kern ist jedoch nahezu vollständig und 99\% der Methoden, Klassen und mehr sind dokumentiert. Einige Beispielprogramme sind bereit, um die Bibliothek zu testen und ihre Mächtigkeit zu zeigen. 
Der erste gedachte Releasetermin war Anfang Oktober 2007, jedoch gab es keinerlei Information, wie man die Bibliothek verweden könnte. Es fehlte zudem eine Kommunikationsplattform. Ich entschloss mich daher noch etwas zu warten. Ein oder zwei Monate vor dem geplanten Release im Oktober wurde mir dann nahegelegt, die Bibliothek vielleicht mit Quelltext offenzulegen. Ein schwerer Schritt. Einerseits hätte ich ja die Bibliothek verkaufen können. Jedoch war andererseits der Aufwand und Support viel zu aufwendig.
Die JEDI\footnote{Joint Endeavour of Delphi Innovators} kannte ich schon von früheren Begegnungen. Und nun nutzte ich die JEDI API Lib Header für die API Einbindung. Ich entschloss mich daher, der JEDI als eigenständiges Projekt beizutreten. Die JWSCL wird daher als Schwesterprojekt neben der JEDI API veröffentlicht. Dies wird auch geschehen in dem Glaube, dass noch andere Delphiprogrammierer ihren Beitrag leisten. 
Aber das wird die Zeit zeigen...
\newline\newline
Euer Christian

\mainmatter						% Hauptteil
%\setpartpreamble[Position][Breite]{Text}
%\setpartpreamble[u, r][6cm]{Dies ist ein Beispiel für eine Part-Präambel.}
%\part[]{Hauptteil}
%\chapter{Gliederung}


\chapter{Präambeln}

Bei der Entwicklung der JEDI Windows Security Code Library war immer der Gedanke der Einfachheit zu gegen. Einfachheit bedeutet jedoch nicht, dass ein Unwissender damit sofort umgehen kann. Wie alles auf der Welt muss ein Grundverständnis vorhanden sein.
Einfachheit bedeutet hier vielmehr, dass die Benutzung ohne Gedanke an Untiefen und Klippen geschehen kann. Die objektorientierte Programmierung unterstüzt diesen Ansatz noch. \\
Leider kann die Einfachheit jedoch nicht immer aufrecht erhalten werden. Entweder etwas ist sehr einfach zu handhaben oder es ist sehr flexibel und mächtig. Beides auf einmal ist nicht möglich. In dieser Situation habe ich mich gegen die Einfachheit und für die Mächtigkeit entschieden. Dies geschah jedoch nicht ohne Dokumentation von Gefahren.


%\setchapterpreamble[u]{%
%\dictum[Luhmann]{Die Klassiker sind Klassiker, weil sie Klassiker sind \dots}}
%\chapter{Diktum}

%Übrigens wird ohne weitere Angaben ein Drittel der aktuellen Textbreite verwendet. Wie fast alles bei der Verwendung von \LaTeX , %kann dies natürlich angepasst werden. Wie das geht und auch alles andere zur Verwendung von Präambeln steht im scrguide 3.\,6.\,2.

\chapter{Grundlagen Sicherheits API}

\section{AccessCheck Teil 1}
\lstset{language=c} 
\begin{lstlisting} 
BOOL WINAPI AccessCheck(
  __in          PSECURITY_DESCRIPTOR pSecurityDescriptor,
  __in          HANDLE ClientToken,
  __in          DWORD DesiredAccess,
  __in          PGENERIC_MAPPING GenericMapping,
  __out_opt     PPRIVILEGE_SET PrivilegeSet,
  __in_out      LPDWORD PrivilegeSetLength,
  __out         LPDWORD GrantedAccess,
  __out         LPBOOL AccessStatus
);
\end{lstlisting}AccessCheck\footnote{http://msdn2.microsoft.com/en-us/library/aa374815.aspx}
\newline\newline\newline
Es ist recht ungewöhnlich am Anfang mit einer anscheindend willkürlichen Funktion zu beginnen. Die Definition der Funktion ist jedoch entscheidend. Denn sie enthält alles was Sicherheit under Windows ausmacht. \emph{AccessCheck} ist \textbf{die} zentrale Funktion!
Um AccessCheck verwenden zu können müssen daher einige Aspekte noch genauer erläutert werden. Dazu zählen
\begin{itemize}
	\item Access mask
	\item Generic Mapping
  \item Security Descriptor
  \item Token
	\item Privilege
\end{itemize}

Wir werden uns daher zuerst mit diesen Dingen beschäftigen und dann zum Schluss nochmals AccessCheck zuwenden.
\subsection{Access Mask}

Die Zugriffsmaske bestimmt die Art und Weise, wie ein Zugriff auf ein Objekt (Datei, Registrierschlüssel ) erfolgen soll. Die Maske bleibt solange bestehen, wie ein Zugriff auf das Objekt erhalten bleibt. Sie entscheidet im weiteren Lebensverlauf des Objekts welche Art von Zugriff gestattet sein soll. Bei Dateien wäre das Beispielsweise Lesen und Schreiben, aber auch Löschen und Ausführen gehört dazu. In Windows gibt es für jedes Objekt eine Vielzahl von Zugriffsmöglichkeiten. Für die bereits angesprochene Dateizugriffe wären das die folgenden Zugriffsrechte\footnote{Die Liste gibt es unter http://msdn2.microsoft.com/en-us/library/aa364399.aspx}



\begin{itemize}
	\item{FILE\_ADD\_FILE 	}
  \item{FILE\_ADD\_SUBDIRECTORY}
  \item{FILE\_ALL\_ACCESS }	
  \item{FILE\_APPEND\_DATA 	}
  \item{FILE\_CREATE\_PIPE\_INSTANCE 	}
  \item{FILE\_DELETE\_CHILD 	}
  \item{FILE\_EXECUTE 	}
  \item{FILE\_LIST\_DIRECTORY 	}
  \item{FILE\_READ\_ATTRIBUTES 	}
  \item{FILE\_READ\_DATA}
  \item{FILE\_READ\_EA 	}
  \item{FILE\_TRAVERSE 	}
  \item{FILE\_WRITE\_ATTRIBUTES 	}
  \item{FILE\_WRITE\_DATA 	}
  \item{FILE\_WRITE\_EA 	}
  \item{STANDARD\_RIGHTS\_READ 		}
  \item{STANDARD\_RIGHTS\_WRITE 	}
  \item{SYNCHRONIZE}
\end{itemize}

Für andere Objekttypen sind die Rechte ähnlich aufgebaut, sowie mehr oder weniger in der Anzahl.\\
Eine Zugriffsmaske wird immer bei der Anforderung eines Objektes angegeben. Man spricht hier jedoch von "`DesiredAccess"', was zum Ausdruck bringt, dass diese Zugriffsmaske die späteren Operationen widerspiegelt. 

\lstset{language=c} 
\begin{lstlisting} 
HANDLE WINAPI CreateFile(
  __in          LPCTSTR lpFileName,
  __in          DWORD dwDesiredAccess,
...);
\end{lstlisting}

Um eine Datei mit CreateFile\footnote{http://msdn2.microsoft.com/en-us/library/aa363858.aspx} zu öffnen oder zu erstellen muss neben dem Dateiname auch der gewünschte Zugriff angegeben werden. Soll die Datei kurz darauf geschrieben werden so muss \emph{FILE\_WRITE\_DATA} angegeben werden. Sollen Attribute gelesen werden, so muss \emph{FILE\_READ\_ATTRIBUTES} angegeben werden. 
\newline
Diese Angaben wird in CreateFile auf Korrektheit überprüft. Kann die Datei nicht beschrieben werden, weil der Zugriff verweigert wird, so schlägt der Aufruf von CreateFile fehl. Ist der Aufruf erfolgreich so wird im späteren Verlauf der Zugriff kein weiteres mal überprüft, auch wenn der Zugriff nachträglich verweigert wird. Dazu muss die Datei geschlossen und erneut mit CreateFile geöffnet werden. Das resultierende Dateihandle wird nur verwendet, um zu überprüfen, ob eine Operation gemäß der gewünschten Zugriffsmaske (DesiredAccess) möglich ist. Ist \emph{FILE\_READ\_DATA} angegeben, so kann kein ReadFile ausgeführt werden. Und ist \emph{FILE\_WRITE\_DATA} angegeben, so kann kein WriteFile ausgeführt werden. \\

Das folgende Programm zeigt, dass ReadFile mit Fehler 5 (Zugriff verweigert) scheitert, wenn in CreateFile \emph{FILE\_WRITE\_DATA} für den Parameter \textit{dwDesiredAccess} verwendet wird.
Würde man im Beispiel \emph{FILE\_READ\_DATA} statt \emph{FILE\_WRITE\_DATA} verwenden und genau im dem Moment zwischen CreateFile und ReadFile über die Dateizugriffsrechte den Lesezugriff verweigern, so würde ReadFile trotzdem funktionieren. 
\newpage
\lstset{language=Delphi} 
\begin{lstlisting} 
program CreateFileTest;
uses
  SysUtils,
  types,
  jwaWindows;

var h : THandle;
    c : Cardinal;
    b : array[0..10] of char;
begin
  SetLastError(0);
  h := CreateFile(
   'CreateFileTest.dpr', //__in          LPCTSTR lpFileName,
   FILE_WRITE_DATA,//__in          DWORD dwDesiredAccess,
   0,//__in          DWORD dwShareMode,
   nil,//__in          LPSECURITY_ATTRIBUTES lpSecurityAttributes,
   OPEN_EXISTING,//__in          DWORD dwCreationDisposition,
   0,//__in          DWORD dwFlagsAndAttributes,
   0//__in          HANDLE hTemplateFile
  );
  if h = INVALID_HANDLE_VALUE then
    RaiseLastOSError;

  if not ReadFile(h,Pointer(@b),sizeof(b),@c,nil) then
   RaiseLastOSError;

  CloseHandle(h);
end.
\end{lstlisting}
Dateizugriffsrechte werden nur einmalig beim Öffnen des Handles überprüft. Dateizugriffsmasken werden bei jeder Operation überprüft.
\newline
Der Typ der Zugriffsmaske ist ein 32 Bit Typ. Die verschiedenen Bits haben die folgende Bedeutung:

\begin{minipage}{\linewidth}
\setlength{\tabcolsep}{1mm}
\tiny{
\begin{tabular}{*{32}{|c}} \hline
31&30&29&28&27&26&25&24&23&22&21&20&19&18&17&16&15&14&13&12&11&10&9&8&7&6&5&4&3&2&1&0\space\space\vline\\\hline
\space & \space & \space & \space & \multicolumn{3}{c|}{\space} & \space & \multicolumn{8}{c|}{\space} & \multicolumn{16}{c|}{\space}\\
GR\footnote{Generic Read}&GW\footnote{Generic Wead}&GE\footnote{Generic Execute}&GA\footnote{Generic All}&\multicolumn{3}{c|}{Reserviert}&AS\footnote{Zugriff auf die System ACL}&\multicolumn{8}{c|}{Standard Zugriffsrechte}&\multicolumn{16}{c|}{objektspezifische ZugriffsRechte}\\\
\space & \space & \space & \space & \multicolumn{3}{c|}{\space} & \space & \multicolumn{8}{c|}{\space} & \multicolumn{16}{c|}{\space}\\\hline
\end{tabular}}
\renewcommand\footnoterule{}
\end{minipage}
\subsubsection{objektspezifischen Rechte}
Die \textbf{objektspezifischen Rechte} sind, wie der Name schon sagt für jedes Objekt definiert. Die Bits 0 bis 15 sind zwar immer dieselben, jedoch definiert jedes Objekt nur ein Teil der kombinierten Bits als gültige Zugriffsrechte. Theoretisch können so bis zu $2^{16}-1 = 65535$ verschiedene Zugriffsrechte definiert werden.\newline

\subsubsection{Standardzugriffsrechte}
Die \textbf{Standardzugriffsrechte} sind für alle Objekte immer dieselben:\\\newline
\small{
\begin{tabular}{|l|l|}\hline
DELETE & Das Recht ein Objekt zu löschen\\
READ\_CONTROL & Das Recht Sicherheitsinformationen des Objekts zu lesen. \\
\space & Das schließt nicht die SYSTEM ACL ein.\\
SYNCHRONIZE & Das Recht das Objekt für Synchronisation zu nutzen. \\
WRITE\_DAC & Das Recht die Sicherheitsinformation des Objekts zu ändern.\\
WRITE\_OWNER & Das Recht den Besitzer des Objekts zu ändern. \\\hline
\end{tabular}}\newline\newline
Es gibt Konstanten, die die obigen Standardrechte kombinieren.\\\\
\begin{tabular}{|l|l|}\hline
STANDARD\_RIGHTS\_ALL & Kombiniert DELETE, READ\_CONTROL, WRITE\_DAC, \\
\space & WRITE\_OWNER, und SYNCHRONIZE Zugriff.\\
STANDARD\_RIGHTS\_EXECUTE & Aktuell READ\_CONTROL\\
STANDARD\_RIGHTS\_READ & Aktuell READ\_CONTROL\\
STANDARD\_RIGHTS\_REQUIRED & Kombiniert DELETE, READ\_CONTROL, WRITE\_DAC, \\
\space & und WRITE\_OWNER Zugriff.\\
STANDARD\_RIGHTS\_WRITE &	Aktuell READ\_CONTROL\\\hline
\end{tabular}
\newline\newline\newline
Die System ACL\footnote{Access Control List engl.\, Zugriffsliste} (kurz SACL) oder auch Überwachungsliste\footnote{engl. Audit ACL} definiert Einträge, die eine Überwachung des Objektes ermöglichen. Diese Liste kann nur mit dem Privilege ACCESS\_SYSTEM\_SECURITY\footnote{Was ein Privileg ist kann im Kapitel Privileg auf Seite \pageref{lab_privilege} nachgelesen werden. Wir kommen darauf jedoch nochmals zurück.} geändert werden. Das Bit 24 (SA) bestimmt daher nicht, ob der Zugriff auf die SACL gestattet ist. Es wird nur verwendet, um den Zugriff auf die SACL zu überwachen.\newline

\subsubsection{Generische Rechte}
Die Bits 28 bis 31 sind für die generischen Zugriffsrechte bestimmt. Sie werden im Kapitel \textbf{Generic Mapping} auf Seite\pageref{lab_generic_mapping} besprochen.

\subsubsection{MAXIMUM\_ALLOWED}

Ein spezielles Recht ist MAXIMUM\_ALLOWED, welches verwendet werden kann, um zu ermitteln, welche Rechte auf ein Objekt erfolgreich
angewendet werden können. MAXIMUM\_ALLOWED wird mit AccessCheck verwendet, welches die möglichen Rechte zurückgibt.
\lstset{language=Delphi} 
\begin{lstlisting} 
MAXIMUM_ALLOWED = $$02000000;
\end{lstlisting}

Dieses Pseudorechte sollte nur in begründeten Fällen eingesetzt werden (z.B. um den Benutzer aufzuklären, was er mit einem Objekt machen darf). Es ist immer die beste Art, nur die wirklich benötigten Rechte zu fordern, als MAXIMUM\_ALLOWED oder GENERIC\_ALL einzusetzen.

\subsection{Generic Mapping}
\label{lab_generic_mapping}
"`Generic Mapping"' bezeichnet die übersetzung der generischen Zugriffsrechte (oder auch Generalrechte) auf die Standard- und Spezialrechten.
Sie sind an sich keine echten Rechte und müssen vor der Verwendung in API Funktionen (wie AccessCheck) in spezifische Rechte
und Standardrechte umgewandelt werden. Die Generalbits werden dabei gelöscht.

Es gibt die folgenden Generalrechte:
\begin{itemize}
	\item{GENERIC\_ALL}
	\item{GENERIC\_READ}
	\item{GENERIC\_WRITE}
	\item{GENERIC\_EXECUTE}
\end{itemize}

Diese Rechte werden mit der Hilfe der API Funktion MapGenericMask auf die objektspezifischen und Standard-Rechte übersetzt.\\
\lstset{language=c} 
\begin{lstlisting} 
VOID WINAPI MapGenericMask(
  __in_out      PDWORD AccessMask,
  __in          PGENERIC_MAPPING GenericMapping
);
\end{lstlisting} 

Der Typ GENERIC\_MAPPING enthält dabei alle vier Generalrechte als Kombination der objektspezifischen und Standard-Rechte.\\
\begin{lstlisting} 
typedef struct _GENERIC_MAPPING {
  ACCESS_MASK GenericRead;
  ACCESS_MASK GenericWrite;
  ACCESS_MASK GenericExecute;
  ACCESS_MASK GenericAll;
} GENERIC_MAPPING, 
 *PGENERIC_MAPPING;
\end{lstlisting} 
\newpage
Ein Beispiel für die konvertierung von General-Dateirechten in spezifische würde dann so aussehen:\\

\lstset{language=delphi} 
\begin{lstlisting} 
const 
  FILE_GENERIC_READ = STANDARD_RIGHTS_READ or FILE_READ_DATA 
    or FILE_READ_ATTRIBUTES or FILE_READ_EA or SYNCHRONIZE; 
  FILE_GENERIC_WRITE = STANDARD_RIGHTS_WRITE or FILE_WRITE_DATA 
    or FILE_WRITE_ATTRIBUTES or FILE_WRITE_EA
    or FILE_APPEND_DATA or SYNCHRONIZE;     
  FILE_GENERIC_EXECUTE = STANDARD_RIGHTS_READ or FILE_READ_DATA
    or FILE_READ_ATTRIBUTES or FILE_READ_EA or SYNCHRONIZE; 
  FILE_ALL_ACCESS = STANDARD_RIGHTS_REQUIRED or SYNCHRONIZE or 511; 
    
var FileMapping : GENERIC_MAPPING;
    MyAccessMask : DWORD;
begin 
  FileMapping.GenericRead := FILE_GENERIC_READ;
  FileMapping.GenericWrite := FILE_GENERIC_WRITE; 
  FileMapping.GenericExecute := FILE_GENERIC_EXECUTE; 
  FileMapping.GenericAll := FILE_ALL_ACCESS; 

  MyAccessMask := GENERIC_ALL;
  MapGenericMask(@MyAccessMask, @FileMapping); 
\end{lstlisting} 

In der Variable \textit{MyAccessMask} wird das Bit 28 (Generic all) gesetzt. Ein Aufruf von AccessCheck würde daher fehlschlagen. Die Funktion MapGenericMask übersetzt daher das GA Bit durch den Inhalt von \textit{FileMapping.GenericAll},
also mit \textit{STANDARD\_RIGHTS\_REQUIRED or SYNCHRONIZE or 511} und man erhält eine korrekte Zugriffsmaske.


 


\subsection{Security Descriptor}
\subsection{Token}
\subsection{Privilege}
\label{lab_privilege}



\section{AccessCheck Teil 2}


\appendix							% Beginn des Anhangs
%\chapter{Schluss}

%Für den Schluss ist zu überlegen, wie man den Anhang formatiert haben möchte: Das KOMA-Script kennt den Befehl \verb#\backmatter#. %Hierdurch wird die Nummerierung der Gliederungseinheiten im Text und im Inhaltsverzeichnis unterdrückt. Erwartet man die übliche %Beschriftung mit "`Anhang A"' bzw. "`A."' so verwendet man den Befehl \verb#\appendix# und verzichte auf \verb#\backmatter# oder %setze es zu einem späteren Punkt ein.

%Viel Spaß! Für Rückfragen, die diese Vorlage betreffen, stehe ich Ihnen gern in der Mailingliste von TXC zur Verfügung. Ansonsten %sind die Dokumente \texttt{lshort}, \texttt{l2tabu}, die \texttt{FAQ der Newsgroup de.text.tex} und natürlich der \texttt{scrguide} %immer sehr hilfreich.

%\backmatter					% Nachspann 

%% Bibliographie unter Verwendung von dinnat %%%%%%%%%%%%%%%%%%%%%%%%%%
%\setbibpreamble{Präambel}		% Text vor dem Verzeichnis
%\bibliographystyle{dinat}
%\bibliography{bibliographie}	% Sie benötigen einen *.bib-Datei



\end{document}
